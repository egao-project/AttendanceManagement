package action;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.Calendar;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import util.DBConnect;
import util.Item;
import action.form.AM_form;

public class Work_Last extends Action {

	@Override
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {

		System.out.println("Work_Last開始");

		// アクションフォームに値を格納する為に定義
		AM_form queryForm = (AM_form) form;

		// Itemクラスを使用する準備
		Item item = new Item();

		// メッセージを初期化
		queryForm.setMessageMain("");
		queryForm.setErrorMessage("");

		// 対象レコード検索用SQL文
		String countSql =  "SELECT COUNT(*) AS emp_no FROM work_info "
				+ "WHERE emp_no = '" + queryForm.getEmpNum() + "' and date = '" + item.getToday() + "' and work_last IS NULL";
		System.out.println(countSql + "\n↑対象レコード検索用のSQL文");

		// 終了時間のUPDATE SQL文
		String sql = "UPDATE attendance_management.work_info SET work_last = ?, real_last = ? WHERE emp_no = ? AND date = ?";
		System.out.println(sql + "\n↑終了時間のUPDATE SQL文");

		// 検索用結果用の変数 0なら本日のレコード無し 1なら有り
		int count;


		// 退勤レコード追加
		try {
			// DB接続
			Class.forName("com.mysql.jdbc.Driver").newInstance();
			con = DBConnect.getConnect();
			stmt = con.createStatement();
			pstmt = con.prepareStatement(sql);
			System.out.println("DB接続");

			// 対象レコードの検索
			rs = stmt.executeQuery(countSql);
			rs.next();
			count = rs.getInt("emp_no");
			System.out.println(count + " ←対象レコードの検索結果");

			// レコードのUPDATE（レコードが有る場合のみ）
			if (count == 1){
				pstmt.setString(1, item.getWorkTime());
				pstmt.setString(2, item.getNowTime());
				pstmt.setString(3, queryForm.getEmpNum());
				pstmt.setString(4, item.getToday());
				pstmt.executeUpdate();
				pstmt.close();
				queryForm.setMessageMain(item.getNowTime() + "  本日もお疲れ様でした！");
				queryForm.setErrorMessage("");
				System.out.println("レコード更新 成功");
			} else {
				queryForm.setMessageMain("");
				queryForm.setErrorMessage("既に退勤が押されています…");
				System.out.println("レコード更新 失敗");
			}
		} catch (ClassNotFoundException e) {
			System.out.println(e + "ドライバのロードに失敗しました");
		} catch (SQLException e) {
			System.out.println(e + "SQL文が間違っています");
		} catch (Exception e) {
			System.out.println(e + "Exception:" + e.getMessage());

		} finally {
			try {
				if (con != null) {
					con.close();
				}
			} catch (SQLException e) {
				System.err.println(e);
			}

			try {
				if (stmt != null) {
					stmt.close();
				}
			} catch (SQLException e) {
				System.err.println(e);
			}

			try {
				if (pstmt != null) {
					pstmt.close();
				}
			} catch (SQLException e) {
				System.err.println(e);
			}
		}

		System.out.println("Work_Last終了");

		// マッピングに値を返す
		return (mapping.findForward("Last"));
	}
}